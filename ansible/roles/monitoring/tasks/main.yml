# --- Namespace ---
- name: Créer le namespace monitoring
  shell: kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

# --- Helm install ---
- name: Vérifier si kube-prometheus-stack est installé
  command: helm status monitoring -n monitoring
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  register: monitoring_status
  failed_when: false
  changed_when: false

- name: Installer kube-prometheus-stack
  command: >
    helm install monitoring kube-prometheus-stack
    --repo https://prometheus-community.github.io/helm-charts
    --namespace monitoring
    --set grafana.adminPassword={{ grafana_password }}
    --set prometheus.prometheusSpec.retention=15d
    --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi
    --set grafana.persistence.enabled=true
    --set grafana.persistence.size=2Gi
    --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.serviceMonitorNamespaceSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.podMonitorNamespaceSelectorNilUsesHelmValues=false
    --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.resources.requests.storage=1Gi
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: monitoring_status.rc != 0

- name: Upgrader kube-prometheus-stack
  command: >
    helm upgrade monitoring kube-prometheus-stack
    --repo https://prometheus-community.github.io/helm-charts
    --namespace monitoring
    --set grafana.adminPassword={{ grafana_password }}
    --set prometheus.prometheusSpec.retention=15d
    --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi
    --set grafana.persistence.enabled=true
    --set grafana.persistence.size=2Gi
    --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.serviceMonitorNamespaceSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false
    --set prometheus.prometheusSpec.podMonitorNamespaceSelectorNilUsesHelmValues=false
    --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.resources.requests.storage=1Gi
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: monitoring_status.rc == 0

- name: Attendre que Grafana soit prêt
  command: kubectl -n monitoring rollout status deployment/monitoring-grafana --timeout=180s
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  changed_when: false

# --- Supprimer l'Ingress Grafana (accès via port-forward uniquement) ---
- name: Supprimer l'Ingress Grafana
  command: kubectl delete ingress grafana -n monitoring --ignore-not-found
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
