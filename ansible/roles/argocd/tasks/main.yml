# --- Namespace ---
- name: Créer le namespace argocd
  shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

# --- Helm install ---
- name: Vérifier si argocd est installé
  command: helm status argocd -n argocd
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  register: argocd_status
  failed_when: false
  changed_when: false

- name: Installer ArgoCD
  command: >
    helm install argocd argo-cd
    --repo https://argoproj.github.io/argo-helm
    --namespace argocd
    --set "configs.params.server\.insecure=true"
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: argocd_status.rc != 0

- name: Upgrader ArgoCD
  command: >
    helm upgrade argocd argo-cd
    --repo https://argoproj.github.io/argo-helm
    --namespace argocd
    --set "configs.params.server\.insecure=true"
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: argocd_status.rc == 0

- name: Attendre que argocd-server soit prêt
  command: kubectl -n argocd rollout status deployment/argocd-server --timeout=120s
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  changed_when: false

# --- Ingress (TLS terminé ici, HTTP vers le pod) ---
- name: Appliquer l'Ingress ArgoCD
  command: kubectl apply -f -
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  args:
    stdin: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: argocd-server
        namespace: argocd
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
      spec:
        ingressClassName: nginx
        tls:
          - hosts:
              - argocd.{{ domain }}
            secretName: argocd-tls
        rules:
          - host: argocd.{{ domain }}
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: argocd-server
                      port:
                        number: 80

# --- Afficher le mot de passe admin ---
- name: Récupérer le mot de passe admin initial
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  register: argocd_password
  changed_when: false

- name: Afficher le mot de passe admin
  debug:
    msg: "ArgoCD admin password: {{ argocd_password.stdout }}"
