apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: app-alerts
  namespace: monitoring
  labels:
    release: monitoring
spec:
  groups:
    - name: app-alerts
      rules:
        - alert: PodCrashLooping
          expr: increase(kube_pod_container_status_restarts_total[10m]) > 3
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
            description: "{{ $labels.pod }} has restarted {{ $value }} times in the last 10 minutes."

        - alert: HighErrorRate
          expr: >
            (
              sum by (namespace) (rate(http_requests_total{status=~"5.."}[5m]))
              /
              sum by (namespace) (rate(http_requests_total[5m]))
            ) > 0.05
            and
            sum by (namespace) (rate(http_requests_total[5m])) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High 5xx error rate in {{ $labels.namespace }}"
            description: "More than 5% of requests are returning 5xx in namespace {{ $labels.namespace }}."

        - alert: PodNotReady
          expr: kube_pod_status_ready{condition="true", namespace!~"kube-system|monitoring"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            description: "{{ $labels.pod }} has been not ready for more than 5 minutes."

        - alert: HighLatency
          expr: >
            histogram_quantile(0.95,
              sum by (namespace, le) (rate(http_request_duration_seconds_bucket[5m]))
            ) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High p95 latency in {{ $labels.namespace }}"
            description: "p95 latency is above 2s in namespace {{ $labels.namespace }}."

    - name: cert-manager-alerts
      rules:
        - alert: CertificateExpiringSoon
          expr: >
            (certmanager_certificate_expiration_timestamp_seconds - time()) < 21 * 24 * 3600
            and
            certmanager_certificate_expiration_timestamp_seconds > 0
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.name }} in {{ $labels.namespace }} expires in less than 21 days"
            description: "Certificate {{ $labels.name }} expires in {{ $value | humanizeDuration }}."

        - alert: CertificateExpiryCritical
          expr: >
            (certmanager_certificate_expiration_timestamp_seconds - time()) < 7 * 24 * 3600
            and
            certmanager_certificate_expiration_timestamp_seconds > 0
          for: 1h
          labels:
            severity: critical
          annotations:
            summary: "Certificate {{ $labels.name }} in {{ $labels.namespace }} expires in less than 7 days"
            description: "Certificate {{ $labels.name }} expires in {{ $value | humanizeDuration }}. Immediate action required."

        - alert: CertificateNotReady
          expr: certmanager_certificate_ready_status{condition="True"} == 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.name }} in {{ $labels.namespace }} is not ready"
            description: "Certificate {{ $labels.name }} has been in a not-ready state for more than 15 minutes."
