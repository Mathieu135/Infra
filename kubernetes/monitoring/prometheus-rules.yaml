apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: app-alerts
  namespace: monitoring
  labels:
    release: monitoring
spec:
  groups:
    - name: app-alerts
      rules:
        - alert: PodCrashLooping
          expr: increase(kube_pod_container_status_restarts_total[10m]) > 3
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
            description: "{{ $labels.pod }} has restarted {{ $value }} times in the last 10 minutes."

        - alert: HighErrorRate
          expr: >
            (
              sum by (namespace) (rate(http_requests_total{status=~"5.."}[5m]))
              /
              sum by (namespace) (rate(http_requests_total[5m]))
            ) > 0.05
            and
            sum by (namespace) (rate(http_requests_total[5m])) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High 5xx error rate in {{ $labels.namespace }}"
            description: "More than 5% of requests are returning 5xx in namespace {{ $labels.namespace }}."

        - alert: PodNotReady
          expr: kube_pod_status_ready{condition="true", namespace!~"kube-system|monitoring"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            description: "{{ $labels.pod }} has been not ready for more than 5 minutes."

        - alert: HighLatency
          expr: >
            histogram_quantile(0.95,
              sum by (namespace, le) (rate(http_request_duration_seconds_bucket[5m]))
            ) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High p95 latency in {{ $labels.namespace }}"
            description: "p95 latency is above 2s in namespace {{ $labels.namespace }}."
