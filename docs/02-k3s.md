# Étape 2 — Installer k3s

> **Statut : DONE** — k3s installé via Ansible et opérationnel.

## Prérequis

- Serveur bootstrappé (étape 1 complétée) ✅

## Pourquoi k3s

- Kubernetes certifié, léger (~512 MB RAM)
- Single binary, installation en 30 secondes
- Facile d'ajouter des nodes plus tard

## Installation via Ansible ✅

Le playbook installe k3s avec Traefik désactivé (remplacé par Ingress NGINX), le chiffrement des secrets etcd (`--secrets-encryption`), l'audit logging apiserver, et Helm 3.

```bash
make k3s
# ou : ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/k3s.yml
```

## Accès kubectl depuis le Mac

### Comment ça fonctionne

Le port 6443 (API Kubernetes) est bloqué par UFW sauf depuis `127.0.0.1`.
Pour utiliser `kubectl` depuis ton Mac, on passe par un **tunnel SSH** :

```
Mac (kubectl) → SSH tunnel → VPS (127.0.0.1:6443) → API k3s
```

Le Mac se connecte en SSH au VPS, et le tunnel redirige le port local 6443 vers le port 6443 du VPS en localhost. UFW voit la connexion venir de `127.0.0.1` → autorisé.

### Setup (une seule fois)

```bash
# Copier le kubeconfig (le fichier est en root, on passe par sudo)
mkdir -p ~/.kube
ssh vps "sudo cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config-vps

# Le fichier pointe déjà vers 127.0.0.1:6443, pas besoin de modifier
```

### Utilisation

```bash
# Terminal 1 : ouvrir le tunnel (depuis la racine du projet)
make tunnel
# ou : ssh -N -L 6443:127.0.0.1:6443 vps

# Terminal 2 : utiliser kubectl
export KUBECONFIG=~/.kube/config-vps
kubectl get nodes
```

Le tunnel reste ouvert tant que le terminal 1 tourne. `Ctrl+C` pour fermer.

## Vérification

```bash
# Vérifier que le cluster tourne
kubectl get nodes
# → vps   Ready   control-plane,master   ...

# Vérifier les pods système
kubectl get pods -n kube-system
# → coredns, metrics-server, etc.

# Vérifier Ingress NGINX
kubectl get svc -n ingress-nginx
# → devrait avoir l'IP externe du serveur
```

## Ajouter un node plus tard (optionnel)

Sur le serveur principal, récupérer le token :

```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

Sur le nouveau node :

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://91.134.142.175:6443 K3S_TOKEN=<token> sh -
```

## Sécurité

| Mesure | Détail |
|--------|--------|
| Chiffrement etcd | `--secrets-encryption` — les Secrets K8s sont chiffrés at-rest |
| Audit logging | Logs dans `/var/log/kubernetes/audit.log`, rétention 30j, 3 backups, 100MB max |
| Audit policy | `/etc/k3s/audit-policy.yaml` — Secrets en Metadata, RBAC en RequestResponse, mutations en Request |

Pour vérifier :

```bash
# Chiffrement etcd
ssh vps "sudo k3s secrets-encrypt status"

# Audit logs
ssh vps "sudo ls -lh /var/log/kubernetes/audit.log"
```

## Fichiers

- `ansible/playbooks/k3s.yml`
- `ansible/roles/k3s/tasks/main.yml`
- `ansible/roles/k3s/files/audit-policy.yaml`
