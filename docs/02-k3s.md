# Étape 2 — Installer k3s

## Prérequis

- Serveur bootstrappé (étape 1 complétée)
- Accès SSH avec le user `deploy`

## Pourquoi k3s

- Kubernetes certifié, léger (~512 MB RAM)
- Inclut Traefik comme Ingress par défaut
- Single binary, installation en 30 secondes
- Facile d'ajouter des nodes plus tard

## Installation via Ansible

Le playbook installe k3s avec les options :

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server \
  --disable=servicelb \
  --tls-san=109.234.167.177 \
  --tls-san=ton-domaine.com" sh -
```

Options expliquées :
- `--disable=servicelb` : on utilise Traefik, pas besoin du ServiceLB intégré
- `--tls-san` : ajouter l'IP et le domaine au certificat de l'API server (pour kubectl distant)

## Récupérer le kubeconfig sur ton Mac

```bash
# Copier le kubeconfig depuis le serveur
scp deploy@109.234.167.177:/etc/rancher/k3s/k3s.yaml ~/.kube/config-o2s

# Éditer pour remplacer 127.0.0.1 par l'IP du serveur
sed -i '' 's/127.0.0.1/109.234.167.177/g' ~/.kube/config-o2s

# Utiliser ce kubeconfig
export KUBECONFIG=~/.kube/config-o2s

# Ou merger avec ton kubeconfig existant
# et switcher avec : kubectl config use-context o2s
```

## Vérification

```bash
# Vérifier que le cluster tourne
kubectl get nodes
# → o2s   Ready   control-plane,master   ...

# Vérifier les pods système
kubectl get pods -n kube-system
# → traefik, coredns, metrics-server, etc.

# Vérifier Traefik
kubectl get svc -n kube-system traefik
# → devrait avoir l'IP externe du serveur
```

## Ajouter un node plus tard (optionnel)

Sur le serveur principal, récupérer le token :

```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

Sur le nouveau node :

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://109.234.167.177:6443 K3S_TOKEN=<token> sh -
```

## Fichiers à créer

- `ansible/playbooks/k3s.yml`
- `ansible/roles/k3s/tasks/main.yml`
- `ansible/roles/k3s/templates/k3s-config.yaml.j2` (optionnel, pour config avancée)
